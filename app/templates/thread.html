{% extends "base.html" %}

{% block title %}{{ thread.title }}{% endblock %}

{% block content %}
<script>
let currentReplyTo = null;
let currentReplyForm = null;

function startReply(commentId, username, userId) {
  // Hide any previously open reply form
  if (currentReplyForm) {
    currentReplyForm.style.display = 'none';
  }
  
  // Show reply context
  const contextEl = document.getElementById('reply-context');
  const contextUsername = document.getElementById('reply-context-username');
  const replyForm = document.getElementById('main-comment-form');
  const parentInput = document.getElementById('parent_comment_id');
  const replyToUserIdInput = document.getElementById('reply_to_user_id');
  const replyToUsernameInput = document.getElementById('reply_to_username');
  const textarea = document.getElementById('comment-textarea');
  
  // Set reply context in form data attributes
  contextUsername.textContent = username;
  parentInput.value = commentId;
  replyToUserIdInput.value = userId || '';
  replyToUsernameInput.value = username || '';
  
  // Keep textarea empty - no @username insertion
  textarea.value = '';
  textarea.focus();
  
  contextEl.style.display = 'flex';
  currentReplyTo = commentId;
  currentReplyForm = null;
  
  // Scroll to form
  replyForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function cancelReply() {
  const contextEl = document.getElementById('reply-context');
  const parentInput = document.getElementById('parent_comment_id');
  const replyToUserIdInput = document.getElementById('reply_to_user_id');
  const replyToUsernameInput = document.getElementById('reply_to_username');
  const textarea = document.getElementById('comment-textarea');
  
  // Don't reset image input - preserve selected file
  // const imageInput = document.getElementById('comment-image-input');
  
  contextEl.style.display = 'none';
  parentInput.value = '';
  replyToUserIdInput.value = '';
  replyToUsernameInput.value = '';
  textarea.value = '';
  currentReplyTo = null;
  // Image input and preview remain unchanged
}

// Image attachment logic for comment form
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('comment-image-input');
  const previewContainer = document.getElementById('comment-image-preview');
  const previewImg = previewContainer?.querySelector('img');
  const removeBtn = previewContainer?.querySelector('.image-preview-remove');

  const attachBtn = document.getElementById('comment-attach-btn');
  const fileNameEl = document.getElementById('comment-file-name');

  if (!input || !previewContainer || !previewImg || !removeBtn || !attachBtn || !fileNameEl) {
    return;
  }

  let currentObjectURL = null;

  input.addEventListener('change', () => {
    const file = input.files && input.files[0];
    if (!file) return;

    // –û—Å–≤–æ–±–æ–¥–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π URL, –µ—Å–ª–∏ –±—ã–ª
    if (currentObjectURL) {
      URL.revokeObjectURL(currentObjectURL);
    }

    currentObjectURL = URL.createObjectURL(file);
    previewImg.src = currentObjectURL;
    previewContainer.classList.remove('d-none');

    // –∏–º—è —Ñ–∞–π–ª–∞
    fileNameEl.textContent = file.name;

    // —Å–ø—Ä—è—Ç–∞—Ç—å —Å–∫—Ä–µ–ø–∫—É
    attachBtn.classList.add('d-none');
  });

  removeBtn.addEventListener('click', () => {
    // –û—Å–≤–æ–±–æ–¥–∏—Ç—å URL
    if (currentObjectURL) {
      URL.revokeObjectURL(currentObjectURL);
      currentObjectURL = null;
    }

    // –æ—á–∏—Å—Ç–∏—Ç—å input
    input.value = '';

    // –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–≤—å—é
    previewImg.src = '';
    previewContainer.classList.add('d-none');

    // –≤–µ—Ä–Ω—É—Ç—å —Å–∫—Ä–µ–ø–∫—É
    attachBtn.classList.remove('d-none');

    // —Å–∫—Ä—ã—Ç—å –∏–º—è —Ñ–∞–π–ª–∞
    fileNameEl.textContent = '';
  });
});
</script>
<!-- –ù–µ–Ω—É–∂–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥ -->
<!-- <div class="mb-3">
  <a href="{{ url_for('routes.threads') }}" class="btn btn-sm btn-outline-secondary mb-2">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç—Ä–µ–¥–∞–º</a>
</div> -->
<div id="thread-root" data-thread-id="{{ thread.id }}">
  <div class="card bg-black border border-secondary shadow-sm mb-3">
    <div class="card-body py-3">
      <div class="d-flex align-items-start justify-content-between gap-3">
        <div class="d-flex align-items-start gap-3">
          {% set author_url = url_for('routes.index')
            if current_user.is_authenticated and thread.author.username == current_user.username
            else url_for('routes.user_profile', username=thread.author.username)
          %}
          <a href="{{ author_url }}" class="text-decoration-none">
            <img
              src="{{ thread.author.avatar_url if thread.author.avatar_url else 'https://api.dicebear.com/7.x/identicon/svg?seed=' + thread.author.username }}"
              alt="AV"
              class="rounded-circle border border-secondary avatar-sm"
              referrerpolicy="no-referrer"
            >
          </a>

          <div class="lh-sm">
            <a class="text-decoration-none post-author-name"
              href="{{ author_url }}">
              {{ thread.author.display_name or thread.author.username }}
            </a>

            <div class="text-secondary small">
              @{{ thread.author.username }} ¬∑ {{ thread.date_posted.strftime('%H:%M | %d.%m.%Y') }}
            </div>
          </div>
        </div>

        {% if current_user.is_admin or thread.author == current_user %}
          <form action="{{ url_for('routes.delete_thread_route', thread_id=thread.id) }}" method="POST" class="m-0">
            <button
              type="submit"
              class="btn btn-sw-danger btn-sm"
              onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–¥?')"
              aria-label="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–¥"
              title="–£–¥–∞–ª–∏—Ç—å"
            >
              üóë
            </button>
          </form>
        {% endif %}
      </div>

      {% if thread.title %}
        <h2 class="h5 mt-3 mb-3 fw-bold">{{ thread.title }}</h2>
      {% endif %}

      <div class="post-content sw-textblock">{{ thread.content|linkify }}</div>

      {% if thread.image_url %}
        <div class="mt-3">
          <img src="{{ thread.image_url }}" alt="Thread image" class="content-image" style="max-width: 100%; height: auto;">
        </div>
      {% endif %}

      {% if current_user.is_authenticated %}
      <div class="vote mt-3 d-flex align-items-center gap-1" data-thread-id="{{ thread.id }}">
        <button class="js-vote-thread btn btn-sm btn-outline-secondary p-1 {{ 'vote-btn-active' if (thread.my_vote|default(0)) == 1 else '' }}" data-value="1" type="button" aria-label="–õ–∞–π–∫">üëç</button>
        <span class="js-thread-score small text-secondary" style="min-width: 1.5rem; text-align: center;">{{ thread.score }}</span>
        <button class="js-vote-thread btn btn-sm btn-outline-secondary p-1 {{ 'vote-btn-active--dislike' if (thread.my_vote|default(0)) == -1 else '' }}" data-value="-1" type="button" aria-label="–î–∏–∑–ª–∞–π–∫">üëé</button>
      </div>
      {% else %}
      <div class="mt-3 small text-secondary">{{ thread.score }}</div>
      {% endif %}
    </div>
  </div>

  <div class="card bg-black border border-secondary shadow-sm">
    <div class="card-body py-3">
      <h5 class="mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>
      
      {# Comment form #}
      {% if current_user.is_authenticated %}
      <form method="post"
          action="{{ url_for('routes.add_comment', thread_id=thread.id) }}"
          enctype="multipart/form-data"
          class="mb-4"
          id="main-comment-form">
        <input type="hidden" name="parent_id" id="parent_comment_id" value="">
        <input type="hidden" name="reply_to_user_id" id="reply_to_user_id" value="">
        <input type="hidden" name="reply_to_username" id="reply_to_username" value="">
        
        <div id="reply-context" class="reply-context" style="display: none;">
          <span>–û—Ç–≤–µ—Ç ‚Üí <span class="reply-context__username" id="reply-context-username"></span></span>
          <button type="button" class="reply-context__cancel" onclick="cancelReply()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <textarea name="content"
            id="comment-textarea"
            class="form-control bg-black text-light border-secondary mb-2 js-autogrow"
            rows="4"
            placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
            required></textarea>

        <!-- <div class="mb-2">
          <input type="file" name="image" accept="image/*" class="form-control comment-image-input" id="comment-image-input">
          <div class="image-preview-container mt-2" id="comment-image-preview" style="display: none;">
            <img src="" alt="Preview" class="image-preview" style="max-width: 100%; max-height: 200px; object-fit: contain;">
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2 image-preview-remove">–£–±—Ä–∞—Ç—å</button>
          </div>
        </div> -->

        <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
          <input
            type="file"
            name="image"
            accept="image/*"
            id="comment-image-input"
            class="d-none"
          >

          <label for="comment-image-input"
            class="btn btn-sm btn-outline-secondary attach-btn"
            id="comment-attach-btn"
            title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
          üìé
          </label>

          <div class="image-preview-container mt-2 d-none" id="comment-image-preview">
            <span class="small text-secondary d-block mb-2" id="comment-file-name"></span>
            <img src="" alt="Preview" class="image-preview" 
            style="max-width: 100%; max-height: 200px; object-fit: contain;">
            <button type="button" 
                class="btn btn-sm btn-outline-secondary mt-2 image-preview-remove">
              –£–±—Ä–∞—Ç—å
            </button>
          </div>
          </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-outline-light btn-sm" type="submit">
            –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
      </form>
      {# Comments list #}
      {% if top_level_comments %}
        {% macro render_comment(comment, depth=0, is_first=False) %}
        <div class="comment-item {% if depth > 0 %}comment-item--reply{% endif %}" 
            id="comment-{{ comment.id }}">
          <div class="d-flex gap-3">
            <img src="{{ comment.author.avatar_url if comment.author.avatar_url else 'https://api.dicebear.com/7.x/identicon/svg?seed=' + comment.author.username }}"
                alt="avatar"
                class="rounded-circle"
                style="width: 36px; height: 36px; object-fit: cover; flex-shrink: 0;">

            <div class="flex-grow-1">
              <div class="small text-muted mb-1">
                <a href="{{ url_for('routes.user_profile', username=comment.author.username) }}"
                    class="text-decoration-none post-author-name">
                    {{ comment.author.username }}
                </a>
                <span class="text-secondary"> ¬∑ {{ comment.date_posted.strftime('%H:%M | %d.%m.%Y') }}</span>
              </div>

              {% if current_user.is_admin or comment.author == current_user %}
              <div class="d-flex justify-content-end mt-1">
                  <form 
                      action="{{ url_for('routes.delete_comment_route', thread_id=thread.id, comment_id=comment.id) }}"
                      method="POST"
                      class="m-0"
                  >
                    <button 
                      type="submit"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')"
                      title="–£–¥–∞–ª–∏—Ç—å"
                    >
                      üóë
                    </button>
                  </form>
                </div>
                {% endif %}
            
              <div class="comment-content">
                {% if comment.reply_to_user_id and comment.reply_to_user %}
                  <a href="{{ url_for('routes.user_profile', username=comment.reply_to_user.username) }}"
                    class="mention">
                    @{{ comment.reply_to_user.username }}
                  </a> 
                {% endif %}
                {{ comment.content | mentions_to_links }}
                
                {% if comment.image_url %}
                  <div class="mt-2">
                    <img src="{{ comment.image_url }}" alt="Comment image" class="content-image content-image--comment" style="max-width: 100%; max-width: 520px; height: auto;">
                  </div>
                {% endif %}
              </div>

              {# Vote and reply #}
              {% if current_user.is_authenticated %}
              <div class="d-flex align-items-center gap-2 mt-1 flex-wrap">
                <div class="vote d-flex align-items-center gap-1" data-comment-id="{{ comment.id }}" data-thread-id="{{ thread.id }}">
                  <button class="js-vote-comment btn btn-sm btn-outline-secondary p-1 {{ 'vote-btn-active' if (comment.my_vote|default(0)) == 1 else '' }}" data-value="1" type="button" aria-label="–õ–∞–π–∫">üëç</button>
                  <span class="js-comment-score small text-secondary" style="min-width: 1.5rem; text-align: center;">{{ comment.score }}</span>
                  <button class="js-vote-comment btn btn-sm btn-outline-secondary p-1 {{ 'vote-btn-active--dislike' if (comment.my_vote|default(0)) == -1 else '' }}" data-value="-1" type="button" aria-label="–î–∏–∑–ª–∞–π–∫">üëé</button>
                </div>
                <button class="btn btn-sm btn-outline-secondary" 
                        type="button" 
                        onclick="startReply('{{ comment.id }}', '{{ comment.author.username }}', '{{ comment.author.id }}')">
                  ‚Ü©
                </button>
              </div>
              {% else %}
              <div class="mt-1 small text-secondary">{{ comment.score }}</div>
              {% endif %}

              {# Render replies recursively #}
              {% if comment.replies %}
                {% for reply in comment.replies %}
                  {{ render_comment(reply, depth + 1, loop.first) }}
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
        {% endmacro %}

        {% for c in top_level_comments %}
          {{ render_comment(c, 0, loop.first) }}
        {% endfor %}
      {% else %}
        <div class="text-muted small py-2">
          –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.
        </div>
      {% endif %}
    {% endif %}
  </div>

</div> {# –∫–æ–Ω–µ—Ü thread-root #}

{% endblock %} {# ‚Üê –ó–ê–ö–†–´–õ–ò block content #}

{% block scripts %}
<script>
(function () {
  const socket = window.SWAMP_SOCKET;
  if (!socket) return;

  const root = document.getElementById('thread-root');
  if (!root) return;

  const threadId = Number(root.dataset.threadId);
  if (!threadId) return;

  socket.emit('join_thread', { thread_id: threadId });

  window.addEventListener('beforeunload', () => {
    socket.emit('leave_thread', { thread_id: threadId });
  });

  const LIST_SELECTOR = '#comments-list';

  socket.on('comment_created', (data) => {
    if (Number(data.thread_id) !== threadId) return;
    const list = document.querySelector(LIST_SELECTOR);
    if (list) list.insertAdjacentHTML('beforeend', data.html);
  });

  socket.on('comment_deleted', (data) => {
    if (Number(data.thread_id) !== threadId) return;
    const el = document.querySelector(`[data-comment-id="${data.comment_id}"]`);
    if (el) el.remove();
  });

  socket.on('comment_score_updated', (data) => {
    const scoreEl = document.querySelector(
      `[data-comment-id="${data.comment_id}"] .js-comment-score`
    );
    if (scoreEl) scoreEl.textContent = data.score;
  });

  socket.on('post_score_updated', (data) => {
    const scoreEl = document.querySelector('.js-thread-score');
    if (scoreEl) scoreEl.textContent = data.score;
  });
})();
</script>
{% endblock %}