{% extends 'base.html' %}

{% block title %}Админка{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <span class="text-muted small">Всего: {{ users|length }}</span>
</div>

<div class="card bg-black border-secondary">
  <div class="card-body">
    <!-- Bulk actions form (only this form wraps the checkboxes) -->
    <form method="POST" action="{{ url_for('routes.admin_delete_users_bulk') }}" class="mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button type="submit" class="btn btn-danger"
                onclick="return confirm('Удалить выбранные аккаунты? Их посты тоже удалятся.');">
          Удалить выбранных
        </button>

        <button type="button" class="btn btn-outline-light" id="btnSelectAll">Выбрать все</button>
        <button type="button" class="btn btn-outline-secondary" id="btnClear">Снять выбор</button>

        <span class="ms-auto small text-muted">
          Текущий пользователь не удаляется через bulk.
        </span>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width:48px;">
                <input type="checkbox" class="form-check-input" id="chkAll">
              </th>
              <th>ID</th>
              <th>Username</th>
              <th style="width:240px;">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>
                {% if u.id != current_user.id %}
                  <input type="checkbox" class="form-check-input js-user" name="user_ids" value="{{ u.id }}">
                {% else %}
                  <input type="checkbox" class="form-check-input" disabled>
                {% endif %}
              </td>

              <td>{{ u.id }}</td>

              <td>
                <!-- Link to user profile -->
                <a class="link-light text-decoration-none"
                   href="{{ url_for('routes.user_profile', username=u.username) }}">
                  {{ u.username }}
                </a>

                {% if u.is_admin %}
                  <span class="badge text-bg-warning ms-2">admin</span>
                {% endif %}
                {% if u.id == current_user.id %}
                  <span class="badge text-bg-info ms-2">you</span>
                {% endif %}
              </td>

              <td class="d-flex gap-2">
                <!-- No nested forms: use button with formaction -->
                <button type="submit"
                        class="btn btn-sm btn-outline-warning"
                        formaction="{{ url_for('routes.admin_delete_user_posts', user_id=u.id) }}"
                        formmethod="post"
                        {% if u.id == current_user.id %}disabled{% endif %}
                        onclick="return confirm('Удалить все посты пользователя {{ u.username }}?');">
                  Удалить посты
                </button>

                <button type="submit"
                        class="btn btn-sm btn-danger"
                        formaction="{{ url_for('routes.admin_delete_user_account', user_id=u.id) }}"
                        formmethod="post"
                        {% if u.id == current_user.id %}disabled{% endif %}
                        onclick="return confirm('Удалить аккаунт {{ u.username }}? Посты тоже удалятся.');">
                  Удалить аккаунт
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  const chkAll = document.getElementById('chkAll');
  const btnSelectAll = document.getElementById('btnSelectAll');
  const btnClear = document.getElementById('btnClear');
  const boxes = () => Array.from(document.querySelectorAll('.js-user'));

  function setAll(v) {
    boxes().forEach(b => b.checked = v);
    if (chkAll) chkAll.checked = v;
  }

  chkAll?.addEventListener('change', () => setAll(chkAll.checked));
  btnSelectAll?.addEventListener('click', () => setAll(true));
  btnClear?.addEventListener('click', () => setAll(false));
})();
</script>
{% endblock %}