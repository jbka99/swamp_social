{# templates/components/_post_card.html #}
{% set author_url = url_for('routes.index')
  if current_user.is_authenticated and post.author.username == current_user.username
  else url_for('routes.user_profile', username=post.author.username)
%}

<div class="card bg-black border border-secondary shadow-sm mb-3">
  <div class="card-body">

    <div class="d-flex align-items-start justify-content-between gap-3">
      <div class="d-flex align-items-start gap-3">

        <a href="{{ author_url }}" class="text-decoration-none">
          <img
            src="{{ post.author.avatar_url if post.author.avatar_url else 'https://api.dicebear.com/7.x/identicon/svg?seed=' + post.author.username }}"
            alt="AV"
            class="rounded-circle border border-secondary"
            style="width: 44px; height: 44px; object-fit: cover;"
            referrerpolicy="no-referrer"
          >
        </a>

        <div class="lh-sm">
          <a class="text-decoration-none text-light fw-semibold"
             href="{{ author_url }}">
            {{ post.author.display_name or post.author.username }}
          </a>

          <div class="text-secondary small">
            @{{ post.author.username }} · {{ post.date_posted.strftime('%H:%M | %d.%m.%Y') }}
          </div>
        </div>
      </div>

      {% if current_user.is_admin or post.author == current_user %}
      <form action="{{ url_for('routes.delete_post', post_id=post.id) }}" method="POST" class="m-0">
        <button
          type="submit"
          class="btn btn-outline-danger btn-sm"
          onclick="return confirm('Удалить этот пост?')"
          aria-label="Удалить пост"
          title="Удалить"
        >
          ×
        </button>
      </form>
      {% endif %}
    </div>

    {% if post.title %}
      <h5 class="mt-3 mb-2">{{ post.title }}</h5>
    {% endif %}
    {% set PREVIEW_LEN = 300 %}
    {% set is_long = post.content|length > PREVIEW_LEN %}
    {% set preview_text = post.content[:PREVIEW_LEN] %}

    <p class="mb-0 text-light-emphasis" style="white-space: pre-wrap;">
      {{ preview_text }}
      {% if is_long %}…{% endif %}
    </p>

    {% if is_long %}
      <div class="collapse mt-2" id="post-{{ post.id }}-full">
        <p class="mb-0 text-light-emphasis" style="white-space: pre-wrap;">
        {{ post.content }}
        </p>
      </div>

    <button
    class="btn btn-sm btn-link link-success px-0 mt-1"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#post-{{ post.id }}-full"
    aria-expanded="false"
    aria-controls="post-{{ post.id }}-full"
    >
    Показать полностью
    </button>
    {% endif %}

  </div>
</div>
